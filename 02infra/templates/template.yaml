# Auto-generated by TNG transpiler version d0d946fd4f0af145429f56efca4367c3238e4d4f
{{- $ns := .Release.Namespace -}}
{{- $__index__ := 0 }}
{{- $inputs := .Values }}
{{- $__prev_index__ := $__index__ }}
{{- $__index__ = 0 }}
{{- range $l, $label := $inputs.myLabels }}
{{- if (eq $label.name $inputs.myFabricGroup) }}
---
apiVersion: srlinux.henderiw.be/v1alpha1
kind: SrlInterface
metadata:
    labels: 
        target: {{ $label.allNetworkDevices }}

    name: infra-systeminterface
    namespace: {{ $ns }}
spec:
    interface: 
        - 
            name: "system0"
            admin-state: "enable"
            description: "tng-k8s-system0"

        - 
            name: "lo0"
            admin-state: "enable"
            description: "tng-k8s-lo0"

        - 
            name: "irb0"
            admin-state: "enable"
            description: "tng-k8s-irb0"


{{- $__index__ = add $__index__ 1 }}
{{- end }}
{{- $__index__ = $__prev_index__ }}
{{- end }}
{{- $__prev_index__ := $__index__ }}
{{- $__index__ = 0 }}
{{- range $l, $label := $inputs.myLabels }}
{{- if (eq $label.name $inputs.myFabricGroup) }}
---
apiVersion: srlinux.henderiw.be/v1alpha1
kind: SrlTunnelinterface
metadata:
    labels: 
        target: {{ $label.allNetworkDevices }}

    name: infra-tunnelinterface
    namespace: {{ $ns }}
spec:
    tunnel-interface: 
        - 
            name: "vxlan0"


{{- $__index__ = add $__index__ 1 }}
{{- end }}
{{- $__index__ = $__prev_index__ }}
{{- end }}
{{- $__prev_index__ := $__index__ }}
{{- $__index__ = 0 }}
{{- range $l, $label := $inputs.myLabels }}
{{- if (eq $label.name $inputs.myFabricGroup) }}
---
apiVersion: srlinux.henderiw.be/v1alpha1
kind: SrlRoutingpolicyPrefixset
metadata:
    labels: 
        target: {{ $label.allNetworkDevices }}

    name: infraprefixset
    namespace: {{ $ns }}
spec:
    prefix-set: 
        {{- if (ne $inputs.myFabricAddressingSchema "ipv6-only") }}
        - 
            name: "system-v4"
            prefix: 
                {{- $__prev_index__ := $__index__ }}
                {{- $__index__ = 0 }}
                {{- range $index, $cidr := $inputs.myFabricLoopBackIpv4Cidr }}
                - 
                    ip-prefix: {{ $cidr }}
                    mask-length-range: "32..32"

                {{- $__index__ = add $__index__ 1 }}
                {{- end }}
                {{- $__index__ = $__prev_index__ }}


        {{- end }}
        {{- if (ne $inputs.myFabricAddressingSchema "ipv4-only") }}
        - 
            name: "system-v6"
            prefix: 
                {{- $__prev_index__ := $__index__ }}
                {{- $__index__ = 0 }}
                {{- range $index, $cidr := $inputs.myFabricLoopBackIpv6Cidr }}
                - 
                    ip-prefix: {{ $cidr }}
                    mask-length-range: "128..128"

                {{- $__index__ = add $__index__ 1 }}
                {{- end }}
                {{- $__index__ = $__prev_index__ }}


        {{- end }}

{{- $__index__ = add $__index__ 1 }}
{{- end }}
{{- $__index__ = $__prev_index__ }}
{{- end }}
{{- $__prev_index__ := $__index__ }}
{{- $__index__ = 0 }}
{{- range $l, $label := $inputs.myLabels }}
{{- if (eq $label.name $inputs.myFabricGroup) }}
---
apiVersion: srlinux.henderiw.be/v1alpha1
kind: SrlRoutingpolicyPolicy
metadata:
    labels: 
        target: {{ $label.allNetworkDevices }}

    name: infraroutingpolicy
    namespace: {{ $ns }}
spec:
    policy: 
        - 
            name: "infra-export-policy-underlay-local"
            statement: 
                {{- if (ne $inputs.myFabricAddressingSchema "ipv6-only") }}
                - 
                    sequence-id: 10
                    match: 
                        prefix-set: "system-v4"


                {{- end }}
                {{- if (ne $inputs.myFabricAddressingSchema "ipv4-only") }}
                - 
                    sequence-id: 20
                    match: 
                        prefix-set: "system-v6"


                {{- end }}



{{- $__index__ = add $__index__ 1 }}
{{- end }}
{{- $__index__ = $__prev_index__ }}
{{- end }}
{{- $__prev_index__ := $__index__ }}
{{- $__index__ = 0 }}
{{- range $k, $node := $inputs.myNodes }}
{{- if (eq $node.kind "srl") }}
---
apiVersion: srlinux.henderiw.be/v1alpha1
kind: SrlInterface
metadata:
    labels: 
        target: {{ $node.name }}

    name: infra-isl-interface-{{ $node.name }}
    namespace: {{ $ns }}
spec:
    interface: 
        {{- $__prev_index__ := $__index__ }}
        {{- $__index__ = 0 }}
        {{- range $index, $ep := $node.endpoints }}
        {{- if (eq $ep.kind "isl") }}
        - 
            name: {{ $ep.name }}
            admin-state: "enable"
            description: "tng-k8s{{$ep.name}}"

        {{- $__index__ = add $__index__ 1 }}
        {{- end }}
        {{- $__index__ = $__prev_index__ }}
        {{- end }}

{{- $__index__ = add $__index__ 1 }}
{{- end }}
{{- $__index__ = $__prev_index__ }}
{{- end }}
{{- $__prev_index__ := $__index__ }}
{{- $__index__ = 0 }}
{{- range $k, $node := $inputs.myNodes }}
{{- if (eq $node.kind "srl") }}
{{- $__prev_index__ := $__index__ }}
{{- $__index__ = 0 }}
{{- range $__key__, $__value__ := $node.endpoints }}
{{- $ep := $__value__ }}
{{- if (eq (kindOf $node.endpoints) "map") }}
{{- $ep = $__key__ }}
{{- end }}
{{- if (eq $ep.kind "loopback") }}
---
apiVersion: srlinux.henderiw.be/v1alpha1
kind: SrlInterfaceSubinterface
metadata:
    labels: 
        target: {{ $node.name }}

    name: infra-system0-subinterface-{{ $node.name }}
    namespace: {{ $ns }}
spec:
    interface-name: "system0"
    subinterface: 
        - 
            index: 0
            admin-state: "enable"
            description: "tng-k8s{{$ep.name}}"
            {{- if (ne $inputs.myFabricAddressingSchema "ipv6-only") }}
            ipv4: 
                address: 
                    - 
                        ip-prefix: {{ $ep.ipv4Prefix }}



            {{- end }}
            {{- if (ne $inputs.myFabricAddressingSchema "ipv4-only") }}
            ipv6: 
                address: 
                    - 
                        ip-prefix: {{ $ep.ipv6Prefix }}



            {{- end }}


{{- $__index__ = add $__index__ 1 }}
{{- end }}
{{- $__index__ = $__prev_index__ }}
{{- end }}
{{- $__index__ = add $__index__ 1 }}
{{- end }}
{{- $__index__ = $__prev_index__ }}
{{- end }}
{{- $__prev_index__ := $__index__ }}
{{- $__index__ = 0 }}
{{- range $k, $node := $inputs.myNodes }}
{{- if (eq $node.kind "srl") }}
{{- $__prev_index__ := $__index__ }}
{{- $__index__ = 0 }}
{{- range $__key__, $__value__ := $node.endpoints }}
{{- $ep := $__value__ }}
{{- if (eq (kindOf $node.endpoints) "map") }}
{{- $ep = $__key__ }}
{{- end }}
{{- if (eq $ep.kind "isl") }}
---
apiVersion: srlinux.henderiw.be/v1alpha1
kind: SrlInterfaceSubinterface
metadata:
    labels: 
        target: {{ $node.name }}

    name: infra-isl-subinterface-{{ $node.name }}{{ ($ep.name | replace "/" "-") }}
    namespace: {{ $ns }}
spec:
    interface-name: {{ $ep.name }}
    subinterface: 
        - 
            index: 0
            admin-state: "enable"
            description: "tng-k8s{{$ep.name}}"
            {{- if (ne $inputs.myFabricAddressingSchema "ipv6-only") }}
            ipv4: 
                address: 
                    - 
                        ip-prefix: {{ $ep.ipv4Prefix }}



            {{- end }}
            {{- if (ne $inputs.myFabricAddressingSchema "ipv4-only") }}
            ipv6: 
                address: 
                    - 
                        ip-prefix: {{ $ep.ipv6Prefix }}



            {{- end }}


{{- $__index__ = add $__index__ 1 }}
{{- end }}
{{- $__index__ = $__prev_index__ }}
{{- end }}
{{- $__index__ = add $__index__ 1 }}
{{- end }}
{{- $__index__ = $__prev_index__ }}
{{- end }}
{{- $__prev_index__ := $__index__ }}
{{- $__index__ = 0 }}
{{- range $k, $node := $inputs.myNodes }}
{{- if (eq $node.kind "srl") }}
---
apiVersion: srlinux.henderiw.be/v1alpha1
kind: SrlNetworkinstance
metadata:
    labels: 
        target: {{ $node.name }}

    name: infra-default-network-instance-{{ $node.name }}
    namespace: {{ $ns }}
spec:
    network-instance: 
        - 
            name: "default"
            type: "default"
            admin-state: "enable"
            description: "tng-k8s-default"
            interface: 
                - 
                    name: "system0.0"

                {{- $__prev_index__ := $__index__ }}
                {{- $__index__ = 0 }}
                {{- range $index, $ep := $node.endpoints }}
                {{- if (eq $ep.kind "isl") }}
                - 
                    name: "{{$ep.name}}.0"

                {{- $__index__ = add $__index__ 1 }}
                {{- end }}
                {{- $__index__ = $__prev_index__ }}
                {{- end }}



{{- $__index__ = add $__index__ 1 }}
{{- end }}
{{- $__index__ = $__prev_index__ }}
{{- end }}
{{- $__prev_index__ := $__index__ }}
{{- $__index__ = 0 }}
{{- range $k, $node := $inputs.myNodes }}
{{- if (eq $node.kind "srl") }}
---
apiVersion: srlinux.henderiw.be/v1alpha1
kind: SrlNetworkinstanceProtocolsBgp
metadata:
    labels: 
        target: {{ $node.name }}

    name: infra-default-protocols-bgp-{{ $node.name }}
    namespace: {{ $ns }}
spec:
    network-instance-name: "default"
    bgp: 
        admin-state: "enable"
        autonomous-system: {{ $node.as }}
        router-id: {{ $node.routerID }}
        ebgp-default-policy: 
            import-reject-all: false
            export-reject-all: false

        group: 
            - 
                group-name: "underlay"
                export-policy: "infra-export-policy-underlay-local"
                admin-state: "enable"
                next-hop-self: true
                ipv4-unicast: 
                    admin-state: "enable"

                ipv6-unicast: 
                    admin-state: "enable"


            - 
                group-name: "overlay"
                admin-state: "enable"
                next-hop-self: true
                evpn: 
                    admin-state: "enable"

                ipv6-unicast: 
                    admin-state: "enable"



        ipv4-unicast: 
            admin-state: "enable"
            multipath: 
                allow-multiple-as: true
                max-paths-level-1: 64
                max-paths-level-2: 64


        ipv6-unicast: 
            admin-state: "enable"
            multipath: 
                allow-multiple-as: true
                max-paths-level-1: 64
                max-paths-level-2: 64


        neighbor: 
            {{- $__prev_index__ := $__index__ }}
            {{- $__index__ = 0 }}
            {{- range $index, $ep := $node.endpoints }}
            {{- if (eq $ep.kind "isl") }}
            - 
                peer-address: {{ (index (splitList "/" $ep.neighbor.ipv4Prefix) 0) }}
                peer-as: {{ $ep.neighbor.as }}
                peer-group: "underlay"

            {{- $__index__ = add $__index__ 1 }}
            {{- end }}
            {{- $__index__ = $__prev_index__ }}
            {{- end }}
            {{- $__prev_index__ := $__index__ }}
            {{- $__index__ = 0 }}
            {{- range $index, $ep := $node.endpoints }}
            {{- if (eq $ep.kind "loopback") }}
            - 
                peer-address: {{ (index (splitList "/" $ep.neighbor.ipv4Prefix) 0) }}
                peer-as: {{ $ep.neighbor.as }}
                peer-group: "overlay"
                local-as: 
                    - 
                        as-number: {{ $ep.neighbor.as }}


                transport: 
                    local-address: {{ (index (splitList "/" $ep.ipv4Prefix) 0) }}


            {{- $__index__ = add $__index__ 1 }}
            {{- end }}
            {{- $__index__ = $__prev_index__ }}
            {{- end }}


{{- $__index__ = add $__index__ 1 }}
{{- end }}
{{- $__index__ = $__prev_index__ }}
{{- end }}
